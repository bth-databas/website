---
title: "Övning CSharp med transaktioner" 
description: "Övning för att använda transaktioner med CSharp."
author: mos
revision:
    "2026-02-06": "(A, mos) Första versionen."
sidebar:
    order: 0410
---

import Figure from '@components/CustomFigure.astro';
import YouTube from '@components/YouTube.astro';

{/*
TODO
* 
* 
*/}

I denna övningen skall vi använda oss av programmeringsspråket CSharp och koppla upp oss mot en befintlig databas och utföra en transaktion för att flytta pengar mellan konton.

{/*
import cs1 from '@assets/databas/csharp/cs1.png';

<Figure 
    src={cs1}
    caption="Ett C# program som presenterar data från databasen classicmodels."
/>
*/}


## Förutsättningar

Du har jobbat igenom övningen "Transaktioner i databas" och du har tillgång till databasen "mydb".



## Spara ditt arbete i ditt kursrepo

I ditt kursrepo, skapa följande katalog där du kan spara ditt arbete med denna övning:

```bash title="Skapa CSharp projekt för övningen"
# Gå till ditt kursrepo
cd kmom/04

# Skapa ett project för CSharp
dotnet new console -o BankExample
cd BankExample

# Öppna katalogen i VS Code
code .
```

Öppna filen `Program.cs` och lägg in följande kommentar, överst i filen.

```sql title="Program.cs"
/**
 * Example code on how to connect to a database using C#.
 * Course: databas
 * Author: Your Name
 * Date: ÅÅÅÅ-MM--DD
 */
```

Uppdatera med rätt datum och namn. 

Kontrollera att du kan köra programmet.

```bash title="Kör CSharp programmet"
dotnet run
```

Om du ser utskriften `Hello, World!` i terminalen så fungerar allt som det ska.



## Installera paket

Förra gången vi byggde ett CSharp-program mot databasen så installerade vi följande tillägg. Gör det nu.

```bash title="Installera paket."
# Stå i katalogen för ditt C# projekt
dotnet add package DotNetEnv
dotnet add package MySqlConnector
dotnet add package Spectre.Console
```

Du får gärna återanvända din tidigare kod om du vill. I denna artikeln kommer vi att återanvända delar av koden som skrevs i föregående övningar.



## Visa innehållet i tabellen account

Vi börjar med en mjukstart för att se att allt fungerar tillsammans och vi skapar en rapport från account tabellen för att visa dess innehåll.

Vi vill se en utskrift som ser ut så här.

```text title="Koppla till databas och visa innehållet i account tabellen."
Connected to the database!
┌──────┬──────┬─────────┐
│  Id  │ Name │ Balance │
├──────┼──────┼─────────┤
│ 1111 │ Adam │    4.00 │
│ 2222 │ Eva  │   16.00 │
└──────┴──────┴─────────┘
```

Hur mycket pengar som finns på kontot just nu spelar mindre roll.



## Flytta 1.5 bitcoin från Adam till Eva

Nu vill vi flytta 1.5 bitcoin från Adam till Eva imon ramen för en transaktion. Med tanke på vad vi lärde oss i föregående övning så skulle vi kunna tänka oss att koden kan se ut så här.

```csharp title="Flytta pengar mellan konton."
    public async Task MoveMoneyFromAdamToEva()
    {
        const string sql = @"
            START TRANSACTION;

            SET @amount = 1.5;
            SET @from = '1111';
            SET @to   = '2222';

            UPDATE `account`
            SET
                `balance` = `balance` - @amount
            WHERE
                `id` = @from;

            UPDATE `account`
            SET
                `balance` = `balance` + @amount
            WHERE
                `id` = @to;

            COMMIT;
            ";
        var cmd = new MySqlCommand(sql, connection);
        await using var result = await cmd.ExecuteReaderAsync();
    }
```

Men, för att detta skall fungera behöver vår connector stödja följande inställningar.

```csharp title="Tillåt mulitquery."
// Tillåter flera SQL-satser i ett och samma kommando (separerade med semikolon)
AllowMultiQueries=true;

// Krävs för att du ska kunna använda SET @variabel i din SQL-sträng
AllowUserVariables=true;
```

Tyvärr stödjer vår connector endast "AllowUserVariables" och den stödjer inte "AllowMultiQueries" (per 2026-01-08 version 2.5.0) så vi behöver strukturera vår transaktion på ett annat sätt.

Här är en variant där vi kan använda oss av transaktioner på ett annat sätt med CSharp.

```csharp title="Ställ flera frågor mot databasen i en transaktion."
    public async Task MoveMoneyFromAdamToEva()
    {
        const double amount=1.5;
        const string fromId="1111";
        const string toId="2222";

        using var transaction = await connection.BeginTransactionAsync();
        try
        {
            const string sqlWithdraw = @"
                UPDATE account
                SET balance = balance - @amount
                WHERE
                    id = @from
                ;";

            const string sqlDeposit = @"
                UPDATE account
                SET balance = balance + @amount
                WHERE
                    id = @to
                ;";

            using var cmdWithdraw = new MySqlCommand(sqlWithdraw, connection, transaction);
            cmdWithdraw.Parameters.AddWithValue("@amount", amount);
            cmdWithdraw.Parameters.AddWithValue("@from", fromId);
            await cmdWithdraw.ExecuteNonQueryAsync();

            using var cmdDeposit = new MySqlCommand(sqlDeposit, connection, transaction);
            cmdDeposit.Parameters.AddWithValue("@amount", amount);
            cmdDeposit.Parameters.AddWithValue("@to", toId);
            await cmdDeposit.ExecuteNonQueryAsync();

            await transaction.CommitAsync();
        }
        catch (Exception ex)
        {
            await transaction.RollbackAsync();
            Console.WriteLine($"Something went wrong: {ex.Message}");
        }
    }
```

Implementera koden ovan i din lösning och studera den i detalj så att du kan se hur de olika delarna fungerar inom ramen för en transaktion med både commit och rollback.



## Gör en mer flexibel sats som kan flytta i godtycklig riktning

Som en avslutande del i övningen så kan du bygga om koden ovan så att den blir mer flexibel så att du från mainprogrammet kan bestämma hur mycket pengar som flyttas och i vilken riktning.

Bygg om main-programmet så att du kan flytta flexibelt med pengar i godtycklig riktning mellan kontona.

Vår transaktion tillåter att det blir negativt belopp på ett av kontona. Men det kan vara okey för tillfället. Vi får lösa den hanteringen lite längre fram.



## Avslutningsvis

Vi har sett hur man kan implementera flera SQL-uttryck inom ramen för en transaktion med CSharp.
