---
title: "Övning CSharp med databasen Classic Models" 
description: "Övning för att komma igång med CSharp och hur man skriver program för att prata med en databas."
author: mos
revision:
    "2026-01-31": "(A, mos) Första versionen."
sidebar:
    order: 0310
---

import Figure from '@components/CustomFigure.astro';
import YouTube from '@components/YouTube.astro';

{/*
TODO
* 
* 
*/}

I denna övningen skall vi använda oss av programmeringsspråket CSharp och koppla upp oss mot en befintlig databas. Vi kommer ställa frågor mot databasen med SELECT och hnatera resultatet för att presentera rapporter för användare.

Som databas använder vi en befintlig databas som heter Classic Models.

import cs1 from '@assets/databas/csharp/cs1.png';

<Figure 
    src={cs1}
    caption="Ett C# program som presenterar data från databasen classicmodels."
/>



## Förutsättningar

Du har tillgång till databasen classicmodels.



## Spara ditt arbete i ditt kursrepo

I ditt kursrepo, skapa följande katalog där du kan spara ditt arbete med denna övning:

```bash title="Skapa CSharp projekt för övningen"
# Gå till ditt kursrepo
cd kmom/03

# Skapa ett project för CSharp och döp det till "DatabaseExample"
dotnet new console -o DatabaseExample
cd DatabaseExample

# Öppna katalogen i VS Code
code .
```

Öppna filen `Program.cs` och lägg in följandekommentar, överst i filen.

```sql title="select.sql"
/**
 * Example code on how to connect to a database using C#.
 * Course: databas
 * Author: Your Name
 * Date: ÅÅÅÅ-MM--DD
 */
```

Uppdatera med rätt datum och namn. 

Kontrollera att du kan köra programmet.

```bash title="Kör CSharp programmet"
dotnet run
```

Om du ser utskriften `Hello, World!` i terminalen så fungerar allt som det ska.



## Installera paket för MariaDB-connectorn

Du behöver installera ett paket för att kunna koppla upp dig mot en MariaDB-databas. Använd följande kommando i terminalen, i katalogen för ditt CSharp-projekt.

```bash title="Installera paket för MariaDB-connectorn"
# Stå i katalogen för ditt C# projekt
dotnet add package MySqlConnector
```

Om installationen gick bra så är du redo att börja använda paketet.

Du kan läsa mer om paketet här: [MySqlConnector på NuGet](https://www.nuget.org/packages/MySqlConnector).



## Installera paket för .env

För att hantera konfigurationsvariabler som databasens användarnamn och lösenord på ett säkert sätt, kan du använda paketet `DotNetEnv` för att läsa in variabler från en `.env`-fil.

Installera paketet med följande kommando i terminalen.

```bash title="Installera paket för .env"
# Stå i katalogen för ditt C# projekt
dotnet add package DotNetEnv
```

Du kan läsa mer om paketet här: [DotNetEnv på NuGet](https://www.nuget.org/packages/DotNetEnv/).

Skapa en fil med namnet `.env` i roten av ditt C#-projekt med följande innehåll.

```env title=".env"
DB_HOST=localhost
DB_USER=dbadm
DB_PASSWORD=P@ssw0rd
DB_NAME=classicmodels
DB_PORT=3306
```

Filen innehåller de detaljer som behövs för att koplla upp sig mot din databas.



## Uppdatera din .gitignore

Se till att din `.gitignore`-fil i roten av ditt kursrepo (översta katalogen i ditt kursrepo) innehåller raden `.env` så att filen med dina känsliga uppgifter inte laddas upp till GitHub.

```gitignore title=".gitignore"
# Ignore environment variable file
.env
```

Du kan även lägga till så att de filer som byggs när du kompilerar ditt csharp-projekt ignoreras.

```gitignore title=".gitignore"
# Ignore CSharp build files
bin/
obj/
```

Gör commit på din .gitignore-fil innan du fortsätter.



## Skapa en koppling mot databasen

Öppna filen `Program.cs` och lägg in följande kod för att skapa en koppling mot databasen classicmodels. 

```csharp title="Program.cs"
using MySqlConnector;

// Load the .env file
DotNetEnv.Env.Load();

// Create a connection string
var builder = new MySqlConnectionStringBuilder
{
    Server = Environment.GetEnvironmentVariable("DB_HOST") ?? "localhost",
    UserID = Environment.GetEnvironmentVariable("DB_USER"),
    Password = Environment.GetEnvironmentVariable("DB_PASSWORD"),
    Database = Environment.GetEnvironmentVariable("DB_NAME"),
    Port = uint.Parse(Environment.GetEnvironmentVariable("DB_PORT") ?? "3306")
};

Console.WriteLine("Ansluter till MariaDB...: " + builder.ConnectionString);

using var connection = new MySqlConnection(builder.ConnectionString);
await connection.OpenAsync();
Console.WriteLine("Ansluten till MariaDB!");

String sql = "SELECT NOW();";
var cmd = new MySqlCommand(sql, connection);
var result = await cmd.ExecuteScalarAsync();
Console.WriteLine($"Databasens tid: {result}");
```

Kör programmet med kommandot `dotnet run`. Om allt fungerar som det ska så skall du se utskriften med databasens tid.

```text
$ dotnet run
Ansluter till MariaDB...: Server=localhost;Port=3306;User ID=dbadm;Password=P@ssw0rd;Database=classicmodels
Ansluten till MariaDB!
Databasens tid: 01/30/2026 12:00:01
```

Innan du går vidare, studera koden ovan och försök förstå vad som händer i varje steg. Förr eller senare behöver du förstå vad de olika delarna gör.



## Flytta koden till en egen klass "Database"

Vi vill förbereda för en god kodstruktur redan från början så vi väljer att flytta koden för databaskopplingen till en egen klass `Database`.

Skapa en ny fil i ditt projekt med namnet `Database.cs` och lägg in följande kod. En del av koden saknas nedan, men du skall fylla i den själv baserat på vad du redan har i `Program.cs`.

```csharp title="Database.cs"
using MySqlConnector;

namespace DatabaseExample;

public static class Database
{
    /// <summary>
    /// Establishes and opens an asynchronous connection to the MariaDB database
    /// using configuration details from environment variables.
    /// </summary>
    /// <returns>A task that represents the asynchronous operation. The task result contains an open <see cref="MySqlConnection"/>.</returns>
    /// <exception cref="MySqlException">Thrown when a connection cannot be established.</exception>
    /// <exception cref="FormatException">Thrown if the DB_PORT environment variable is not a valid number.</exception>
    public static async Task<MySqlConnection> GetConnectionAsync()
    {
        // Code to create the connection string and
        // then open the connection

        return connection;
    }
}
```

Klassen skall inte hantera några konfigurationsdetaljer utan bara ansvara för att skapa och öppna en koppling mot databasen samt förvänta sig att rätt detaljer ligger som miljövariabler i `.env`-filen och att de lästs in av main-programmet.

När detta är klart behöver vi uppdatera `Program.cs` för att använda den nya klassen `Database`.

Uppdatera filen `Program.cs` så att den använder klassen `Database` för att skapa kopplingen.

```csharp title="Program.cs"
using DatabaseExample;
using MySqlConnector;

// Load the .env file
DotNetEnv.Env.Load();

// Connect to the database
using var connection = await Database.GetConnectionAsync();
Console.WriteLine("Ansluten till databasen!");

// Execute a simple query
string sql = "SELECT NOW();";
var cmd = new MySqlCommand(sql, connection);
var result = await cmd.ExecuteScalarAsync();
Console.WriteLine($"Databasens tid: {result}");
```

Bra, nu ser main-programmet mycket renare ut och vi har flyttat ansvaret för databaskopplingen till en egen klass.



## Skapa en klass "Queries" för databasfrågor

Låt oss göra en justering av koden till, vi placerar alla databasfrågor i en egen klass.

Skapa en ny fil i ditt projekt med namnet `Queries.cs` och lägg in följande kod. En del av koden saknas nedan, men du skall fylla i den själv baserat på vad du redan har i `Program.cs`.

```csharp title="Queries.cs"
using MySqlConnector;
namespace DatabaseExample;
public class Queries(MySqlConnection connection)
{
    private readonly MySqlConnection connection = connection;

    public async Task GetDatabaseTime()
    {
        // Code to execute the query and print the result
        // This method returns nothing
    }
}
``` 

Uppdatera filen `Program.cs` så att den använder klassen `Queries` för att köra databasfrågor.

```csharp title="Program.cs"
using DatabaseExample;
using MySqlConnector;

// Load the .env file
DotNetEnv.Env.Load();

// Connect to the database
using var connection = await Database.GetConnectionAsync();
Console.WriteLine("Ansluten till databasen!");

// Execute a simple query
Queries query = new Queries(connection);
await query.GetDatabaseTime();
```

Nu har du en bra grundstruktur för att fortsätta med fler databasfrågor i din CSharp-applikation.

Main-programmet blir rent och enkelt att läsa, klassen `Database` hanterar anslutningen till databasen och klassen `Queries` hanterar alla databasfrågor.



## Skriv ut rapport i en tabell

Vi vill nu skapa en metod i Queries-klassen som skriver ut en rapport utifrån en given SELECT-sats.

Modulen vi använder kan du installera på följande sätt.

```bash title="Installera paket för att skriva ut rapporter i tabellformat."
# Stå i katalogen för ditt C# projekt
dotnet add package Spectre.Console
```

Läs om paketet här: [Spectre.Console på NuGet](https://www.nuget.org/packages/Spectre.Console/).

För att skapa en enkel metod för att testa hur rapporten kan skrivas ut, lägg till följande metod i klassen `Queries`.

```csharp title="Queries.cs"
using Spectre.Console;

    // Inside the Queries class
    public async Task PrintProductsReport()
    {
        string sql = "SELECT productCode, productName, buyPrice FROM products LIMIT 10;";
        var cmd = new MySqlCommand(sql, connection);
        using var result = await cmd.ExecuteReaderAsync();

        var table = new Table();
        table.AddColumn(new TableColumn("[yellow]Product Code[/]").Centered());
        table.AddColumn("[yellow]Product Name[/]");
        table.AddColumn(new TableColumn("[yellow]Buy Price[/]").RightAligned());

        while (await result.ReadAsync())
        {
            table.AddRow(
                result.GetString("productCode"),
                result.GetString("productName"),
                result.GetDecimal("buyPrice").ToString("N2")
            );
        }

        AnsiConsole.Write(table);
    }
```

Provkör din kod och se att den skriver ut en tabell med produkter från databasen, ungefär så här.

```text
┌──────────────┬───────────────────────────────────────┬───────────┐
│ Product Code │ Product Name                          │ Buy Price │
├──────────────┼───────────────────────────────────────┼───────────┤
│   S10_1678   │ 1969 Harley Davidson Ultimate Chopper │     48.81 │
│   S10_1949   │ 1952 Alpine Renault 1300              │     98.58 │
│   S10_2016   │ 1996 Moto Guzzi 1100i                 │     68.99 │
│   S10_4698   │ 2003 Harley-Davidson Eagle Drag Bike  │     91.02 │
│   S10_4757   │ 1972 Alfa Romeo GTA                   │     85.68 │
│   S10_4962   │ 1962 LanciaA Delta 16V                │    103.42 │
│   S12_1099   │ 1968 Ford Mustang                     │     95.34 │
│   S12_1108   │ 2001 Ferrari Enzo                     │     95.59 │
│   S12_1666   │ 1958 Setra Bus                        │     77.90 │
│   S12_2823   │ 2002 Suzuki XREO                      │     66.27 │
└──────────────┴───────────────────────────────────────┴───────────┘
```

Läs gärna på mer om vilka möjligheter som paketet ger för att skapa snygga tabeller i terminalen: [Spectre.Console Tables](https://spectreconsole.net).



## Välj att visa en produkt baserat på produktkod

Låt oss bygga kod för ett exmepel där vi vill visa detaljer för en produkt baserat på produktkoden.

I main-programmet kan det se ut så här:

```csharp title="Program.cs"
Console.Write("Enter product code: ");
string? productCode = Console.ReadLine() ?? string.Empty;
await query.PrintProductByCode(productCode);
```

I klassen `Queries` lägger vi till följande metod för att visa detaljer för en produkt baserat på produktkoden.

```csharp title="Queries.cs"
    public async Task PrintProductByCode(string productCode)
    {
        if (string.IsNullOrEmpty(productCode))
        {
            AnsiConsole.MarkupLine("[yellow]The product code was empty, nothing to show.[/]");
            return;
        }

        const string sql = @"
            SELECT
                productCode,
                productName,
                productDescription,
                buyPrice,
                MSRP
            FROM products
            WHERE
                productCode = @productCode;
            ";

        using var cmd = new MySqlCommand(sql, connection);
        cmd.Parameters.AddWithValue("@productCode", productCode);

        using var result = await cmd.ExecuteReaderAsync();

        if (await result.ReadAsync())
        {
            // Setup a vertical property table
            var table = new Table()
                .Border(TableBorder.Rounded)
                .HideHeaders()
                .AddColumn("Property")
                .AddColumn("Value");

            // Populate table with product data
            table.AddRow("[bold yellow]Product Code[/]", result.GetString("productCode"));
            table.AddRow("[bold yellow]Product Name[/]", result.GetString("productName"));
            table.AddRow("[bold yellow]Description[/]", result.GetString("productDescription"));
            table.AddRow("[bold yellow]Buy Price[/]", $"[green]{result.GetDecimal("buyPrice"):N2}[/]");
            table.AddRow("[bold yellow]MSRP[/]", $"[green]{result.GetDecimal("MSRP"):N2}[/]");

            // Render to terminal
            AnsiConsole.Write(
                new Panel(table)
                    .Header($"[bold white]Product Details[/]")
                    .Expand()
            );
        }
        else
        {
            AnsiConsole.MarkupLine($"[red]No product found with code:[/] [bold]{productCode}[/]");
        }
    }
```

Provkör din kod och se att den skriver ut detaljer för produkten med den angivna produktkoden. Det kan se ut ungefär så här.

```text
Enter product code: S10_1949
┌─Product Details───────────────────────────────────────────────────────────────────────────────┐
│ ╭──────────────┬────────────────────────────────────────────────────────────────────────────╮ │
│ │ Product Code │ S10_1949                                                                   │ │
│ │ Product Name │ 1952 Alpine Renault 1300                                                   │ │
│ │ Description  │ Turnable front wheels; steering function; detailed interior; detailed      │ │
│ │              │ engine; opening hood; opening trunk; opening doors; and detailed chassis.  │ │
│ │ Buy Price    │ 98.58                                                                      │ │
│ │ MSRP         │ 214.30                                                                     │ │
│ ╰──────────────┴────────────────────────────────────────────────────────────────────────────╯ │
└───────────────────────────────────────────────────────────────────────────────────────────────┘
```



## Prepared statements

I frågan ovan fanns följande del med.

```csharp title="Queries.cs"
cmd.Parameters.AddWithValue("@productCode", productCode);
```

Det är ett exempel på något som kallas för prepared statements. Det är ett sätt att skydda sig mot SQL-injektioner genom att separera SQL-koden från de värden som användaren anger. Genom att använda prepared statements så ser databasmotorn till att värdena hanteras på ett säkert sätt.



## Söka i tabellen

Låt oss göra ett exempel till där vi vill söka i tabellen produkter baserat på ett sökord. Sökordet kan användaren ange när programmet körs.

I main-programmet kan det se ut så här:

```csharp title="Program.cs"
Console.Write("Search for product code or product name: ");
string? searchTerm = Console.ReadLine() ?? string.Empty;
await query.SearchProductsByNameOrCode(searchTerm);
``` 

I klassen `Queries` lägger vi till följande metod för att söka produkter baserat på ett sökord.

```csharp title="Queries.cs"
    public async Task SearchProductsByNameOrCode(string searchTerm)
    {
        if (string.IsNullOrEmpty(searchTerm))
        {
            AnsiConsole.MarkupLine("[yellow]The search string was empty, nothing to show.");
            return;
        }

        string sql = @"
            SELECT
                productCode,
                productName,
                buyPrice
            FROM products
            WHERE
                productCode LIKE @searchTerm
                OR productName LIKE @searchTerm
            LIMIT 10
            ;";
        var cmd = new MySqlCommand(sql, connection);
        cmd.Parameters.AddWithValue("@searchTerm", "%" + searchTerm + "%");

        using var result = await cmd.ExecuteReaderAsync();

        var table = new Table();
        table.AddColumn(new TableColumn("[yellow]Product Code[/]").Centered());
        table.AddColumn("[yellow]Product Name[/]");
        table.AddColumn(new TableColumn("[yellow]Buy Price[/]").RightAligned());

        while (await result.ReadAsync())
        {
            table.AddRow(
                result.GetString("productCode"),
                result.GetString("productName"),
                result.GetDecimal("buyPrice").ToString("N2")
            );
        }

        AnsiConsole.Write(table);
    }
```

Det känns troligen som vi upprepar lite kod, men det är inte vårt fokus just nu. Men, när vi är klara med övningen kan vi fundera på hur vi kan förbättra koden ytterligare. Kanske är det något du kan göra på egen hand.

Provkör din kod och se att den skriver ut en tabell med produkter som matchar sökordet från databasen. Det kan se ut så här

```text
Search for product code or product name: Harley
┌──────────────┬───────────────────────────────────────┬───────────┐
│ Product Code │ Product Name                          │ Buy Price │
├──────────────┼───────────────────────────────────────┼───────────┤
│   S10_1678   │ 1969 Harley Davidson Ultimate Chopper │     48.81 │
│   S10_4698   │ 2003 Harley-Davidson Eagle Drag Bike  │     91.02 │
│   S18_2625   │ 1936 Harley Davidson El Knucklehead   │     24.23 │
└──────────────┴───────────────────────────────────────┴───────────┘
```

Nu har vi nog grunderna på plats för att kunna bygga vidare med CSharp och databaser.



## Linter Rosalynator

För att hjälpa till med kodkvalitet och stil kan vi använda Roslynator som är en samling av analysverktyg för CSharp.

{/*
Installera Roslynator med följande kommando i terminalen.

```bash title="Installera Roslynator"
# Stå i katalogen för ditt C# projekt
dotnet add package Roslynator.Analyzers
```

Du kan läsa mer om paketet här: [Roslynator.Analyzers på NuGet](https://www.nuget.org/packages/Roslynator.Analyzers/).

För att köra paketet och fixa kodstil, använd följande kommando i terminalen.

```bash title="Kör Roslynator för att fixa kodstil"
dotnet format
```
*/}

Du kan installera terminalklienten för Roslynator globalt med följande kommando.

```bash title="Installera Roslynator CLI globalt"
dotnet tool install -g roslynator.dotnet.cli
```

Du kan läsa mer om Roslynator CLI här: [Roslynator CLI på GitHub](https://www.nuget.org/packages/Roslynator.DotNet.Cli)

Detta gör att du kan köra kommandot `roslynator` från terminalen var som helst.

Här är exempel på hur du kan köra Roslynator från terminalen för att analysera och fixa kodstil i ditt projekt.

```bash title="Kör Roslynator CLI för att analysera och fixa kodstil"
# Stå i katalogen för ditt C# projekt
roslynator analyze
```

Om du vill fixa till kodstilen automatiskt kan du använda följande kommando.

```bash title="Kör Roslynator CLI för att fixa kodstil automatiskt"
# Stå i katalogen för ditt C# projekt
roslynator fix
```

Se alltid till att din kod passerar linterkontroller innan du gör en commit.



## EditorConfig

Med tanke på lintning så kan det också vara vettigt att uppdatera din fil `.editorconfig` som ligger i roten av ditt kursrepo för att passa CSharp (och SQL).

Lägg till följande sektion i din `.editorconfig`-fil (skapa filen om du inte har den).

```editorconfig title=".editorconfig"
root = true

[*.{cs,sql}]
indent_size = 4
indent_style = space
charset = utf-8
trim_trailing_whitespace = true
insert_final_newline = true

[*.sql]
sql_keyword_case = upper
sql_identifier_case = lowercase
```



## Avslutningsvis

Bra gjort, då har du kommit igång med CSharp och databaser. Du har skapat en bra grundstruktur för att bygga vidare med fler databasfrågor i din CSharp-applikation.

Om du har tid och energi kvar så kan du fundera på hur du kan förbättra koden ytterligare. Kanske är det något du kan göra på egen hand. Till exempel har du en del duplicerad kod i klassen `Queries` som kan förbättras.
